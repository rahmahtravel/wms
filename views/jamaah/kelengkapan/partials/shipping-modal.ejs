<!-- Shipping Modal -->
<div id="shippingModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full z-50">
  <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-2/3 lg:w-1/2 shadow-lg rounded-lg bg-white">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-xl font-bold text-gray-900 flex items-center">
        <i class="fas fa-shipping-fast text-blue-600 mr-2"></i>
        <span id="shippingModalTitle">Tambah Data Pengiriman</span>
      </h3>
      <button onclick="closeShippingModal()" class="text-gray-400 hover:text-gray-600">
        <i class="fas fa-times text-xl"></i>
      </button>
    </div>

    <!-- Loading State -->
    <div id="shippingLoading" class="flex items-center justify-center py-8">
      <div class="text-center text-gray-600">
        <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
        <p>Memuat data...</p>
      </div>
    </div>

    <!-- Jamaah Information -->
    <div id="shippingJamaahInfo" class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg p-4 mb-6 hidden">
      <div class="flex items-center space-x-3">
        <div class="h-12 w-12 rounded-full bg-blue-500 flex items-center justify-center text-white font-bold text-lg">
          <span id="shippingJamaahInitial">J</span>
        </div>
        <div class="flex-1">
          <h4 class="font-semibold text-gray-900" id="shippingJamaahName">-</h4>
          <div class="text-sm text-gray-600 space-y-1">
            <div class="flex items-center">
              <i class="fas fa-phone w-4 mr-2"></i>
              <span id="shippingJamaahPhone">-</span>
            </div>
            <div class="flex items-center">
              <i class="fas fa-map-marker-alt w-4 mr-2"></i>
              <span id="shippingJamaahAddress">Belum ada alamat</span>
            </div>
          </div>
        </div>
        <div class="text-right">
          <div class="text-xs text-gray-500 mb-1">Status Kelengkapan</div>
          <span id="shippingStatusBadge" class="px-2 py-1 text-xs rounded-full bg-gray-100 text-gray-800">
            Belum Diambil
          </span>
        </div>
      </div>
    </div>

    <!-- Form -->
    <form id="shippingForm" class="space-y-6 hidden">
      <input type="hidden" id="shippingKelengkapanId" name="kelengkapan_id">
      
      <!-- Current Shipping Info (if exists) -->
      <div id="currentShippingInfo" class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 hidden">
        <div class="flex items-center mb-2">
          <i class="fas fa-info-circle text-yellow-600 mr-2"></i>
          <h5 class="font-medium text-yellow-800">Data Pengiriman Saat Ini</h5>
        </div>
        <div class="text-sm space-y-1">
          <div><strong>Ekspedisi:</strong> <span id="currentEkspedisi">-</span></div>
          <div><strong>No. Resi:</strong> <span id="currentNoResi">-</span></div>
          <div><strong>Catatan:</strong> <span id="currentNotes">-</span></div>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <!-- Ekspedisi -->
        <div class="md:col-span-1">
          <label class="block text-sm font-medium text-gray-700 mb-2">
            <i class="fas fa-truck mr-1"></i>Ekspedisi *
          </label>
          <select id="ekspedisi" name="ekspedisi" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            <option value="">Pilih Ekspedisi</option>
            <option value="JNE">JNE</option>
            <option value="TIKI">TIKI</option>
            <option value="POS Indonesia">POS Indonesia</option>
            <option value="J&T Express">J&T Express</option>
            <option value="SiCepat Ekspres">SiCepat Ekspres</option>
            <option value="Ninja Xpress">Ninja Xpress</option>
            <option value="AnterAja">AnterAja</option>
            <option value="Lion Parcel">Lion Parcel</option>
            <option value="ID Express">ID Express</option>
            <option value="Wahana Prestasi Logistik">Wahana Prestasi Logistik</option>
            <option value="SAP Express">SAP Express</option>
            <option value="Indah Logistik">Indah Logistik</option>
            <option value="Rosalia Express">Rosalia Express</option>
            <option value="Rex Kiriman Express">Rex Kiriman Express</option>
            <option value="Sentral Cargo">Sentral Cargo</option>
            <option value="NCS">NCS</option>
          </select>
        </div>

        <!-- No Resi -->
        <div class="md:col-span-1">
          <label class="block text-sm font-medium text-gray-700 mb-2">
            <i class="fas fa-barcode mr-1"></i>No. Resi *
          </label>
          <input type="text" id="noResi" name="no_resi" required 
                 placeholder="Masukkan nomor resi" 
                 class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        </div>
      </div>

      <!-- Tracking Notes -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">
          <i class="fas fa-sticky-note mr-1"></i>Catatan Tracking
        </label>
        <textarea id="trackingNotes" name="tracking_notes" rows="3" 
                  placeholder="Catatan tambahan untuk tracking pengiriman..."
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
        <p class="text-xs text-gray-500 mt-1">Opsional: Catatan khusus untuk tracking atau instruksi pengiriman</p>
      </div>

      <!-- Auto Update Status -->
      <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
        <div class="flex items-center space-x-3">
          <i class="fas fa-info-circle text-blue-600"></i>
          <div class="text-sm text-blue-800">
            <p class="font-medium mb-1">Informasi</p>
            <p>Setelah data resi disimpan, status pengambilan akan otomatis berubah menjadi "Di Kirim".</p>
          </div>
        </div>
      </div>

      <!-- Form Actions -->
      <div class="flex justify-end space-x-3 pt-4 border-t">
        <button type="button" onclick="closeShippingModal()" 
                class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition">
          <i class="fas fa-times mr-2"></i>Batal
        </button>
        <button type="submit" 
                class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
          <i class="fas fa-save mr-2"></i>Simpan Data Resi
        </button>
      </div>
    </form>

    <!-- Error State -->
    <div id="shippingError" class="text-center text-red-600 py-8 hidden">
      <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
      <p>Gagal memuat data kelengkapan</p>
      <button onclick="loadShippingData()" class="mt-3 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
        Coba Lagi
      </button>
    </div>
  </div>
</div>

<script>
let currentShippingKelengkapanId = null;

function openShippingModal(kelengkapanId) {
  currentShippingKelengkapanId = kelengkapanId;
  document.getElementById('shippingModal').classList.remove('hidden');
  
  // Reset and show loading state
  document.getElementById('shippingLoading').classList.remove('hidden');
  document.getElementById('shippingJamaahInfo').classList.add('hidden');
  document.getElementById('shippingForm').classList.add('hidden');
  document.getElementById('shippingError').classList.add('hidden');
  
  // Load shipping data
  loadShippingData();
}

function closeShippingModal() {
  document.getElementById('shippingModal').classList.add('hidden');
  currentShippingKelengkapanId = null;
}

async function loadShippingData() {
  if (!currentShippingKelengkapanId) return;
  
  try {
    const response = await fetch(`/jamaah/kelengkapan/${currentShippingKelengkapanId}/status`);
    const data = await response.json();
    
    if (!response.ok) {
      throw new Error(data.error || 'Failed to load data');
    }
    
    // Populate jamaah info
    document.getElementById('shippingJamaahName').textContent = data.nama_jamaah || '-';
    document.getElementById('shippingJamaahPhone').textContent = data.nomor_telp || '-';
    document.getElementById('shippingJamaahAddress').textContent = data.alamat || 'Belum ada alamat';
    document.getElementById('shippingJamaahInitial').textContent = 
      data.nama_jamaah ? data.nama_jamaah.charAt(0).toUpperCase() : 'J';
    
    // Update status badge
    const statusBadge = document.getElementById('shippingStatusBadge');
    statusBadge.textContent = data.status_pengambilan || 'Belum Diambil';
    statusBadge.className = 'px-2 py-1 text-xs rounded-full ';
    
    switch(data.status_pengambilan) {
      case 'Sudah Diambil':
        statusBadge.className += 'bg-green-100 text-green-800';
        break;
      case 'Di Kirim':
        statusBadge.className += 'bg-blue-100 text-blue-800';
        break;
      default:
        statusBadge.className += 'bg-red-100 text-red-800';
    }
    
    // Set form data
    document.getElementById('shippingKelengkapanId').value = currentShippingKelengkapanId;
    
    // Check if shipping data exists
    if (data.no_resi && data.no_resi.trim() !== '') {
      document.getElementById('shippingModalTitle').textContent = 'Edit Data Pengiriman';
      document.getElementById('currentShippingInfo').classList.remove('hidden');
      
      // Show current data
      document.getElementById('currentEkspedisi').textContent = data.ekspedisi || '-';
      document.getElementById('currentNoResi').textContent = data.no_resi || '-';
      document.getElementById('currentNotes').textContent = data.tracking_notes || 'Tidak ada catatan';
      
      // Fill form with current values for editing
      document.getElementById('ekspedisi').value = data.ekspedisi || '';
      document.getElementById('noResi').value = data.no_resi || '';
      document.getElementById('trackingNotes').value = data.tracking_notes || '';
      
      // Update submit button text
      const submitBtn = document.querySelector('#shippingForm button[type="submit"]');
      submitBtn.innerHTML = '<i class="fas fa-save mr-2"></i>Update Data Resi';
    } else {
      document.getElementById('shippingModalTitle').textContent = 'Tambah Data Pengiriman';
      document.getElementById('currentShippingInfo').classList.add('hidden');
      
      // Clear form for new entry
      document.getElementById('shippingForm').reset();
      document.getElementById('shippingKelengkapanId').value = currentShippingKelengkapanId;
      
      // Reset submit button text
      const submitBtn = document.querySelector('#shippingForm button[type="submit"]');
      submitBtn.innerHTML = '<i class="fas fa-save mr-2"></i>Simpan Data Resi';
    }
    
    // Show content
    document.getElementById('shippingLoading').classList.add('hidden');
    document.getElementById('shippingJamaahInfo').classList.remove('hidden');
    document.getElementById('shippingForm').classList.remove('hidden');
    
  } catch (error) {
    console.error('Error loading shipping data:', error);
    document.getElementById('shippingLoading').classList.add('hidden');
    document.getElementById('shippingError').classList.remove('hidden');
  }
}

// Form submission
document.getElementById('shippingForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  if (!currentShippingKelengkapanId) return;
  
  const formData = new FormData(this);
  const submitData = {
    ekspedisi: formData.get('ekspedisi'),
    no_resi: formData.get('no_resi'),
    tracking_notes: formData.get('tracking_notes') || null,
    status_pengambilan: 'Di Kirim'  // Auto set status when resi is added
  };
  
  try {
    const response = await fetch(`/jamaah/kelengkapan/${currentShippingKelengkapanId}/shipping`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(submitData)
    });
    
    const result = await response.json();
    
    if (result.success) {
      // Show success message based on action
      const isEdit = document.getElementById('shippingModalTitle').textContent.includes('Edit');
      const message = isEdit ? 'Data pengiriman berhasil diperbarui!' : 'Data pengiriman berhasil disimpan!';
      
      if (typeof swalSuccess === 'function') {
        swalSuccess(message, true);
      } else {
        alert(message);
        window.location.reload();
      }
      closeShippingModal();
    } else {
      throw new Error(result.error || 'Gagal menyimpan data');
    }
    
  } catch (error) {
    console.error('Error saving shipping data:', error);
    if (typeof swalError === 'function') {
      swalError('Gagal menyimpan data: ' + error.message);
    } else {
      alert('Gagal menyimpan data: ' + error.message);
    }
  }
});
</script>